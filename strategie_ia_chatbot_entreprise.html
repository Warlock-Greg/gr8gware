<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Balise Title Optimisée pour le SEO et la Longue Traîne -->
    <title>Stratégie d'Intégration d'un Agent IA Dédidé : Grounding, Souveraineté et Démo Chatbot Augmenté</title>
    <!-- Méta-description engageante et riche en mots-clés -->
    <meta name="description" content="Découvrez notre méthodologie complète pour déployer un Agent IA d'entreprise sur mesure, garantissant la souveraineté des données, l'audit (grounding) et une réduction significative des coûts opérationnels grâce au Human-in-the-Loop (HitL). Testez notre Chatbot démo avec raccourcis RH, Rédaction et Produit.">
    <!-- Mots-clés pertinents pour les moteurs de recherche -->
    <meta name="keywords" content="Agent IA entreprise, stratégie IA, grounding, RAG, souveraineté des données, réduction coûts IA, Human-in-the-Loop, chatbot sur mesure, intégration IA PME, Démo Chatbot, Agent IA RH, Reformulation Email IA, Agent Produit">
    
    <!-- Chargement de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chargement des icônes Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            font-family: 'Inter', sans-serif;
        }
        /* Style Gaming Subtil pour les Titres et Éléments IA */
        .gaming-title {
            font-weight: 900; 
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }
        .content-section h2 {
            margin-top: 2rem;
            margin-bottom: 1rem;
            font-size: 1.75rem; /* text-2xl */
            /* Application de la police gaming subtle */
            font-weight: 800; 
            letter-spacing: 0.05em;
            color: #065f46; /* emerald-700 */
            border-bottom: 2px solid #a7f3d0; /* emerald-200 */
            padding-bottom: 0.5rem;
        }
        .content-section h3 {
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            font-size: 1.25rem; /* text-xl */
            font-weight: 600; /* font-semibold */
            color: #374151; /* gray-700 */
        }
        .content-section p, .content-section li {
            line-height: 1.7;
            margin-bottom: 1rem;
        }
        .content-section ul, .content-section ol {
            margin-left: 1.5rem;
            list-style-type: disc;
            margin-bottom: 1rem;
        }
        .seo-table th, .seo-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        .seo-table th {
            background-color: #d1fae5; /* emerald-100 */
            font-weight: 600;
        }
        /* Styles spécifiques pour le Chatbot */
        #chat-window {
            height: 400px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 16px;
            background-color: #f0fff4; /* green-50, couleur très claire */
            border: 1px solid #a7f3d0; /* emerald-200 */
        }
        .message {
            max-width: 85%;
            padding: 10px 14px;
            border-radius: 18px;
            word-wrap: break-word;
        }
        .user-message {
            align-self: flex-end;
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            border-bottom-right-radius: 4px;
        }
        .ai-message {
            align-self: flex-start;
            background-color: #a7f3d0; /* emerald-200 */
            color: #065f46; /* emerald-700 */
            border-bottom-left-radius: 4px;
            white-space: pre-wrap;
            /* Utilisation d'une ombre subtile pour l'effet 'gaming/HUD' */
            box-shadow: 1px 1px 3px rgba(6, 95, 70, 0.2); 
        }
        .spinner-chat {
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-left-color: #059669; /* emerald-600 */
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .shortcut-button {
            @apply flex items-center justify-center p-2 text-xs sm:text-sm bg-white border border-indigo-400 text-indigo-700 rounded-lg hover:bg-indigo-100 transition duration-150 shadow-md;
        }

          :root {
            --primary: #7C3AED;
            --secondary: #10B981;
            --background-light: #F9FAFB;
            --text-dark: #1F2937;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-light);
            color: var(--text-dark);
        }
        .text-gradient-main {
            background-image: linear-gradient(to right, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .btn-primary {
            background-color: var(--primary);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.4);
        }
        .btn-primary:hover {
            background-color: #8B5CF6;
            transform: translateY(-1px);
        }
        .icon-box-primary {
            background-color: var(--primary);
            color: white;
            padding: 1rem;
            border-radius: 0.75rem;
            display: inline-flex;
            margin-bottom: 1rem;
        }
        .ia-step-card {
            background-color: white;
            border: 1px solid #E5E7EB;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            border-left: 4px solid var(--primary);
        }
        .ia-step-card:hover {
            border-left: 4px solid var(--secondary);
            transform: translateY(-2px);
        }

   @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Merriweather:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .article-content {
            font-family: 'Merriweather', serif;
            line-height: 1.8;
            color: #374151;
        }
        .chatbot-container {
            min-height: 600px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        .messages-list {
            flex-grow: 1;
            overflow-y: auto;
            scroll-behavior: smooth;
        }
    </style>
</head>
<body class="antialiased">
      <!-- Navbar simplifiée -->
    <header class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <a href="index.html" class="text-3xl font-extrabold tracking-tight text-gray-900">
                GR8<span class="text-secondary">G</span>ware
            </a>
            <nav class="space-x-4">
                <a href="index.html#expertise" class="text-gray-600 hover:text-primary transition duration-200">Retour Accueil</a>
                <a href="digitalness.html" class="text-gray-600 hover:text-secondary transition duration-200">Digitalness</a>
                <a href="strategie_ia_chatbot_entreprise.html" class="text-gray-600 hover:text-secondary transition duration-200">chatBot Interne</a>
                <a href="#contact-form" class="btn-primary px-4 py-2 rounded-lg text-white">Lancer l'Audit IA</a>
            </nav>
        </div>
    </header>

    
    <section class="bg-gray-50 flex justify-center p-4 sm:p-8">
    
    <div class="w-full max-w-6xl bg-white shadow-2xl rounded-xl overflow-hidden">

        <!-- En-tête Principal et Titre Optimisé -->
        <header class="text-center p-6 bg-indigo-700 text-white border-b border-indigo-500">
            <h1 class="text-3xl sm:text-4xl gaming-title leading-tight">
                Stratégie d'Intégration d'un Agent IA Dédidé
            </h1>
            <p class="mt-2 text-lg text-indigo-200">
                Feuille de route stratégique complète et Testez l'Agent IA d'entreprise en temps réel.
            </p>
        </header>

        <!-- Contenu de l'Article et Chatbot en Disposition Latérale -->
        <main class="p-4 sm:p-8 lg:p-10 grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Colonne 1: Contenu de l'Article (2/3 de la largeur) -->
            <article class="content-section text-gray-700 lg:col-span-2">

                <p class="text-lg italic border-l-4 border-emerald-500 pl-4 mb-8">
                    L'intégration réussie de l'Intelligence Artificielle générative en milieu professionnel nécessite une approche stratégique et sur mesure, axée sur la souveraineté des données, l'auditabilité des réponses et l'optimisation des coûts.
                </p>

                <!-- PHASE 1: Analyse des Besoins (Optimisation Longue Traîne) -->
                <h2>Phase 1 : Déterminer les besoins réels en IA de vos salariés</h2>
                
                <p>Avant de coder, il faut écouter et analyser. L'IA ne doit pas être une fin en soi, mais un outil ciblé. Cette étape est cruciale pour cibler les tâches où l'IA apportera le meilleur retour sur investissement (ROI).</p>

                <h3>1. Cartographie Précise des Cas d'Usage pour l'IA Générative</h3>
                <p>Il est crucial de cartographier les tâches et les questions récurrentes des équipes. Cette étape permet d'identifier les domaines où l'IA peut apporter un gain de temps significatif et où la compétence en langage naturel est indispensable. Une analyse des requêtes est la clé.</p>
                <ul>
                    <li>**Audit des Requêtes Internes :** Analyse des tickets de support (RH, IT, juridique) ou des FAQ pour identifier les goulots d'étranglement.</li>
                    <li>**Entretiens Utilisateurs Ciblés :** Discussion avec les futurs utilisateurs (employés) pour comprendre les difficultés de recherche d'information.</li>
                    <li>**Cas d'Usage Ciblés :** Définir des cas d'usage précis et mesurables (ex: "Réduire de 30% le temps de recherche des documents contractuels").</li>
                </ul>

                <h3>2. Délimitation Stratégique : Quand utiliser l'IA vs. l'Automatisation Traditionnelle ?</h3>
                <p>Toute question ou tâche n'a pas besoin d'une IA générative. Faire la distinction permet de **réduire les coûts d'exécution et d'augmenter la fiabilité**.</p>

                <div class="overflow-x-auto my-6">
                    <table class="w-full min-w-max seo-table border rounded-lg">
                        <thead>
                            <tr>
                                <th class="bg-emerald-100 text-emerald-800">Type de Tâche</th>
                                <th class="bg-emerald-100 text-emerald-800">Solution Recommandée</th>
                                <th class="bg-emerald-100 text-emerald-800">Avantage Compétitif</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Tâches Répétitives, Déterministes (Règles strictes et binaires)</td>
                                <td>Automatisation Robotique (RPA), Scripts, Bases de données structurées</td>
                                <td>Moins coûteux à l'exécution, 100% de fiabilité, évite les "hallucinations".</td>
                            </tr>
                            <tr>
                                <td>Recherche, Synthèse, Rédaction, Q&A Contextuel, Brainstorming</td>
                                <td>Agent IA Dédidé (LLM) avec Grounding (RAG)</td>
                                <td>Nécessite la compréhension et la génération de langage naturel dans des corpus complexes.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- PHASE 2: Développement et Sécurité -->
                <h2>Phase 2 : Développer un Agent IA, Grounding et Souveraineté</h2>
                <p>L'agent dédié est conçu pour être sécurisé, précis et intégré à l'écosystème de l'entreprise. C'est ici que la notion de fiabilité et de conformité est abordée comme pilier central.</p>

                <h3>1. Assurer la Fiabilité avec le Grounding (RAG)</h3>
                <p>Le plus grand défi des IA génératives est l'« hallucination » (invention de faits). Pour les questions d'entreprise (RH, Juridique), l'agent d'entreprise doit impérativement utiliser la technique de **Génération Augmentée par la Récupération (RAG)**.  Le RAG s'assure que le Modèle de Langage (LLM) se base uniquement sur des documents internes validés.</p>
                <ul>
                    <li>**Mécanisme de Preuve :** L'IA répond en se basant *uniquement* sur les documents de l'entreprise qui lui sont fournis dynamiquement.</li>
                    <li>**Garantie de Référence :** Chaque réponse générée doit fournir les sources précises (nom du document, paragraphe) pour vérification.</li>
                </ul>

                <h3>2. Souveraineté des Données et Confiance Numérique</h3>
                <p>La gestion de l'IA doit répondre aux impératifs réglementaires et de confidentialité, notamment dans le contexte européen.</p>
                <ul>
                    <li>**Hébergement Contrôlé :** L'agent IA doit être hébergé sur une infrastructure cloud privée ou souveraine, garantissant la localisation des données.</li>
                    <li>**Politique d'Opt-Out Stricte :** Les données sensibles de l'entreprise ne sont **jamais** utilisées pour l'entraînement des modèles tiers.</li>
                    <li>**Anonymisation :** Mise en place de protocoles d'anonymisation pour les données personnelles lors de leur traitement par l'agent.</li>
                </ul>

                <h3>3. Le Filet de Sécurité : Implémenter le Human-in-the-Loop (HitL)</h3>
                <p>Le HitL est le mécanisme de *failover* intelligent qui intervient lorsque l'agent n'est pas sûr de sa réponse, assurant ainsi une qualité de service constante et un apprentissage continu. </p>
                <ul>
                    <li>**Système d'Auto-Évaluation :** L'agent est programmé pour évaluer sa propre confiance dans la réponse (score de confiance).</li>
                    <li>**Déclenchement HitL :** Si le niveau de confiance est trop bas (par exemple, < 70%), la requête est transférée à l'équipe humaine (expert métier) avec le contexte complet et l'ébauche de réponse de l'IA.</li>
                    <li>**Apprentissage :** Chaque cas résolu par l'humain est utilisé pour réindexer la base de connaissances et entraîner l'Agent IA.</li>
                </ul>
                
                <!-- PHASE 3: Pilotage et Optimisation des Coûts -->
                <h2>Phase 3 : Réduire les Coûts et Piloter la Consommation de l'IA</h2>

                <p>L'avantage d'un agent dédié et bien architecturé est la transparence et le contrôle des coûts, permettant de justifier l'investissement sur le long terme.</p>

                <h3>1. Suivi Granulaire des Métriques de Consommation IA</h3>
                <p>Chaque interaction est une transaction traçable, permettant un pilotage précis de la consommation.</p>
                <ul>
                    <li>**Coût par Requête :** Suivi du coût en tokens (entrée et sortie) par réponse générée.</li>
                    <li>**Taux de Succès IA :** Pourcentage de questions traitées entièrement par l'agent sans intervention humaine. Cet indicateur est clé pour le ROI.</li>
                    <li>**Taux d'Échec (HitL) :** Mesure le nombre de transferts à l'humain. L'objectif est de réduire ce taux avec le temps.</li>
                    <li>**Latence Moyenne :** Mesure le temps de réponse de l'agent.</li>
                </ul>
                
                <h3>2. Stratégies Actives de Réduction des Coûts IA</h3>
                <p>Comment concrètement une entreprise peut-elle utiliser l'IA de manière plus économique sans compromettre la qualité ?</p>
                <ul>
                    <li>**Architecture Modulaire :** Utiliser des modèles plus petits et plus rapides (ex: Gemini Flash) pour 80% des tâches courantes (synthèse simple, Q&A). Utiliser uniquement les grands modèles (ex: Gemini Pro) pour les tâches complexes (analyse de données volumineuses, raisonnement complexe).</li>
                    <li>**Optimisation du Prompt Engineering :** Rendre les invites concises et spécifiques pour réduire le nombre de tokens dans la fenêtre contextuelle.</li>
                    <li>**Capitalisation du HitL :** Chaque cas résolu par le support humain doit être systématiquement transformé en document indexé par le RAG pour que l'IA puisse le traiter la prochaine fois.</li>
                </ul>
                
            </article>

            <!-- Colonne 2: Chatbot de Démonstration (1/3 de la largeur) -->
            <aside class="lg:col-span-1">
                <div class="sticky top-10 bg-emerald-50 p-6 rounded-lg shadow-xl border border-emerald-200">
                    <h3 class="text-xl gaming-title text-emerald-800 mb-4 flex items-center">
                        <i data-lucide="bot" class="w-5 h-5 mr-2"></i>
                        Agent IA d'Entreprise
                    </h3>
                    <p class="text-sm text-gray-600 mb-4">
                        Testez les capacités de l'Agent IA : questions générales ou raccourcis métiers pré-formatés.
                    </p>

                    <!-- BOUTONS DE RACCOURCI (Style Émeraude/Indigo) -->
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <button class="shortcut-button" data-prompt="Quelles sont les règles de l'entreprise concernant le télétravail ?" data-type="rh">
                            <i data-lucide="users" class="w-4 h-4 mr-1"></i> RH (Processus Internes)
                        </button>
                        <button class="shortcut-button" data-prompt="J'ai besoin d'une reformulation professionnelle et concise de ce brouillon de mail : 'Salut, peux-tu me renvoyer le rapport de la semaine passée ? Ça urge un peu. Merci.' " data-type="redaction">
                            <i data-lucide="pencil" class="w-4 h-4 mr-1"></i> Reformuler un Mail
                        </button>
                        <button class="shortcut-button col-span-2 bg-indigo-50 hover:bg-indigo-200 border-indigo-500" data-prompt="Quelles sont les nouveautés de l'offre 'Vélo Challenge' et où puis-je en savoir plus ?" data-type="produit">
                            <i data-lucide="rocket" class="w-4 h-4 mr-1 text-indigo-700"></i> Offre Produit (Vélo Challenge)
                        </button>
                    </div>

                    <!-- Fenêtre de Chat -->
                    <div id="chat-window" class="rounded-lg mb-4">
                        <div class="message ai-message">
                            Bonjour ! Je suis l'Agent IA de démonstration. Je peux vous aider sur la stratégie d'intégration IA, vos processus internes ou la rédaction de contenu.
                        </div>
                    </div>

                    <!-- Zone de Saisie du Chat -->
                    <div class="flex gap-2">
                        <input type="text" id="chat-input" placeholder="Posez votre question..."
                               class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                        <button id="chat-send-button"
                                class="p-3 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition duration-200 disabled:bg-emerald-400 flex items-center justify-center">
                            <i data-lucide="send" class="w-5 h-5" id="send-icon"></i>
                            <div id="chat-spinner" class="spinner-chat hidden"></div>
                        </button>
                    </div>

                    <!-- Message d'erreur et sources du Chatbot -->
                    <div id="chat-error-message" class="text-red-600 bg-red-100 p-2 rounded-lg mt-3 text-sm hidden"></div>
                    <div id="chat-citation-container" class="mt-3 p-2 bg-emerald-100 rounded-lg text-xs hidden">
                        <h4 class="font-semibold text-emerald-800">Sources :</h4>
                        <ul id="chat-citation-list" class="list-disc list-inside space-y-0.5 text-emerald-700"></ul>
                    </div>
                </div>
            </aside>
        </main>

        <!-- Pied de page -->
        <footer class="p-6 border-t border-gray-200 bg-gray-100 text-center">
            <p class="text-gray-600">
                <a href="index.html" class="text-indigo-600 hover:text-indigo-800">Retour à l'Accueil</a> | Contactez-nous pour une analyse personnalisée.
            </p>
        </footer>
    </div>
    </section>

    <script type="module">
        // --- Configuration et Utilitaires de l'API Gemini pour le Chatbot ---
        const apiKey = ""; // La clé API sera fournie par l'environnement d'exécution
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        const MAX_RETRIES = 5;

        // Éléments du Chatbot
        const chatWindow = document.getElementById('chat-window');
        const chatInput = document.getElementById('chat-input');
        const chatSendButton = document.getElementById('chat-send-button');
        const chatSpinner = document.getElementById('chat-spinner');
        const sendIcon = document.getElementById('send-icon');
        const chatErrorMessage = document.getElementById('chat-error-message');
        const chatCitationContainer = document.getElementById('chat-citation-container');
        const chatCitationList = document.getElementById('chat-citation-list');
        const shortcutButtons = document.querySelectorAll('.shortcut-button');

        let chatHistory = []; 

        // Fonction d'attente (pour l'exponentiel backoff)
        const delay = ms => new Promise(res => setTimeout(res, ms));

        // Fonction pour gérer l'appel à l'API avec backoff
        async function fetchWithBackoff(url, options, retries = 0) {
            try {
                const response = await fetch(url, options);
                if (response.status === 429 && retries < MAX_RETRIES) {
                    const delayTime = Math.pow(2, retries) * 1000 + Math.random() * 1000;
                    console.warn(`Rate limit hit. Retrying in ${delayTime / 1000}s...`);
                    await delay(delayTime);
                    return fetchWithBackoff(url, options, retries + 1);
                }
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                return response;
            } catch (error) {
                if (retries < MAX_RETRIES) {
                    const delayTime = Math.pow(2, retries) * 1000 + Math.random() * 1000;
                    console.warn(`Erreur de connexion. Nouvelle tentative dans ${delayTime / 1000}s...`, error);
                    await delay(delayTime);
                    return fetchWithBackoff(url, options, retries + 1);
                }
                throw new Error("Échec de la connexion à l'API après plusieurs tentatives.");
            }
        }

        /**
         * Ajoute un message à la fenêtre de chat
         * @param {string} text - Contenu du message.
         * @param {string} sender - 'user' ou 'ai'.
         */
        function addMessageToChat(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.innerHTML = text; // Utiliser innerHTML pour les liens et le formatage
            messageDiv.classList.add('message', sender === 'user' ? 'user-message' : 'ai-message');
            chatWindow.appendChild(messageDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight; // Défilement automatique
        }

        /**
         * Envoie le message au modèle Gemini
         * @param {string} prompt - La question de l'utilisateur.
         * @param {string} type - Le type de requête (rh, redaction, produit, ou standard).
         */
        async function sendChat(prompt, type = 'standard') {
            chatErrorMessage.classList.add('hidden');
            chatCitationContainer.classList.add('hidden');
            chatCitationList.innerHTML = '';

            // 1. Ajouter le prompt utilisateur à l'historique et à l'interface
            addMessageToChat(prompt, 'user');
            
            // Ajouter l'entrée utilisateur à l'historique pour le contexte
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });

            // 2. Préparer le payload de l'API avec un prompt système ajusté
            
            let currentSystemPrompt = `Vous êtes un agent IA d'entreprise spécialisé. Votre rôle est de répondre de manière professionnelle et concise. Maintenez le contexte de la conversation.`;

            // Simulation d'Agent Local Préformaté : On injecte les règles spécifiques via le System Prompt
            if (type === 'rh') {
                 // Simulation de Q&A sur des documents RH internes (RAG Simulé)
                currentSystemPrompt = `Vous êtes l'Agent RH. Répondez aux questions sur les processus internes de manière concise en vous basant sur la politique de télétravail suivante : 'Le télétravail est autorisé deux jours par semaine, après approbation du manager et formation obligatoire en cybersécurité. Un formulaire de demande doit être soumis 14 jours à l'avance.'`;
            } else if (type === 'redaction') {
                 // Simulation de tâche de génération (Prompt Engineering pour une tâche spécifique)
                currentSystemPrompt = `Vous êtes l'Agent Rédaction. Votre unique objectif est de prendre le texte fourni par l'utilisateur et de le reformuler pour le rendre professionnel, concis et respectueux du ton formel de l'entreprise. Ne vous écartez pas de cette tâche.`;
            } else if (type === 'produit') {
                 // Simulation de réponse avec un lien hypertexte spécifique (comme l'IA trouverait le lien dans le RAG)
                 currentSystemPrompt = `Vous êtes l'Agent Commercial Produit. Votre mission est de fournir des informations sur l'offre 'Vélo Challenge'. Les nouveautés sont : un suivi GPS intégré et un classement hebdomadaire par équipe. Le lien vers la page produit interne est: [PAGE PRODUIT/offre-velo-challenge]. Veuillez inclure le lien dans votre réponse.`;
            } else {
                currentSystemPrompt = `Vous êtes un agent IA d'entreprise spécialisé dans la stratégie d'intégration de l'IA. Répondez aux questions sur les sujets d'intégration, Grounding, RAG, HitL. Utilisez le Grounding (Google Search) pour trouver des informations factuelles et à jour.`;
            }
            
            const payload = {
                contents: chatHistory,
                // Utiliser Google Search pour le grounding, sauf pour la simulation de l'agent produit où l'on veut une réponse hyper-spécifique.
                tools: type !== 'produit' ? [{ "google_search": {} }] : undefined, 
                systemInstruction: { parts: [{ text: currentSystemPrompt }] },
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            };

            // 3. Afficher l'état de chargement
            chatInput.disabled = true;
            chatSendButton.disabled = true;
            sendIcon.classList.add('hidden');
            chatSpinner.classList.remove('hidden');

            try {
                const response = await fetchWithBackoff(apiUrl, options);
                const result = await response.json();
                
                const candidate = result.candidates?.[0];

                if (!candidate || !candidate.content?.parts?.[0]?.text) {
                     throw new Error("La réponse de l'IA est vide.");
                }

                let aiText = candidate.content.parts[0].text;
                
                // Traitement spécifique pour l'Agent Produit (conversion du lien simulé en HTML)
                if (type === 'produit') {
                    // Remplace le lien interne simulé par un lien HTML cliquable
                    aiText = aiText.replace(/\[PAGE PRODUIT\/([^\]]+)\]/g, (match, linkText) => {
                        const targetUrl = `page_produit_offre-velo-challenge.html`;
                        return `<a href="${targetUrl}" target="_blank" class="text-indigo-600 font-semibold hover:underline">Accéder à la page produit (Simulé)</a>`;
                    });
                }


                // 4. Extraction des sources (citations)
                let sources = [];
                const groundingMetadata = candidate.groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    sources = groundingMetadata.groundingAttributions
                        .map(attribution => ({
                            uri: attribution.web?.uri,
                            title: attribution.web?.title,
                        }))
                        .filter(source => source.uri && source.title);
                }

                // 5. Mettre à jour l'historique et l'interface
                addMessageToChat(aiText, 'ai');
                chatHistory.push({ role: "model", parts: [{ text: aiText }] });

                // 6. Affichage des sources
                if (sources.length > 0) {
                    chatCitationContainer.classList.remove('hidden');
                    const uniqueSources = Array.from(new Set(sources.map(s => s.uri)))
                        .map(uri => sources.find(s => s.uri === uri));

                    uniqueSources.forEach(source => {
                        const li = document.createElement('li');
                        li.innerHTML = `<a href="${source.uri}" target="_blank" class="text-emerald-700 hover:underline">${source.title}</a>`;
                        chatCitationList.appendChild(li);
                    });
                }
                
            } catch (error) {
                console.error("Erreur Chatbot:", error);
                chatErrorMessage.textContent = `Une erreur s'est produite lors de la connexion : ${error.message}`;
                chatErrorMessage.classList.remove('hidden');
                // Retirer le dernier message utilisateur de l'historique s'il n'a pas pu être traité
                chatHistory.pop();
            } finally {
                // 7. Masquer l'état de chargement
                chatInput.disabled = false;
                chatSendButton.disabled = false;
                sendIcon.classList.remove('hidden');
                chatSpinner.classList.add('hidden');
                chatInput.value = ''; // Vider le champ
                chatInput.focus();
            }
        }

        // --- Gestion des événements d'interface ---

        function handleSend() {
            const prompt = chatInput.value.trim();
            if (prompt) {
                sendChat(prompt, 'standard');
            }
        }

        // Gestion du clic sur les boutons de raccourci
        shortcutButtons.forEach(button => {
            button.addEventListener('click', () => {
                const prompt = button.dataset.prompt;
                const type = button.dataset.type;
                chatInput.value = prompt; // Pré-remplir l'input
                sendChat(prompt, type);
            });
        });

        // Événement clic sur le bouton d'envoi
        chatSendButton.addEventListener('click', handleSend);

        // Événement touche "Entrée"
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); 
                handleSend();
            }
        });

        // Initialisation des icônes Lucide
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
        });

    </script>
</body>
</html>
